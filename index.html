<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="ScreenOrientation" content="autoRotate:disabled">


  <!-- Ar.js for nft markers  -->
  <script
    src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>

  <!-- Aframe for a-frame components and end a frame extras for gesture detecting -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v5.0.1/dist/aframe-extras.min.js"></script>
  <!-- Gesture decting add to scene in order to work -->
  <script>

    AFRAME.registerComponent("gesture-detector", {
      schema: {
        element: { default: "" }
      },

      init: function () {
        this.targetElement =
          this.data.element && document.querySelector(this.data.element);

        if (!this.targetElement) {
          this.targetElement = this.el;
        }

        this.internalState = {
          previousState: null
        };

        this.emitGestureEvent = this.emitGestureEvent.bind(this);

        this.targetElement.addEventListener(
          "touchstart",
          this.emitGestureEvent
        );

        this.targetElement.addEventListener(
          "touchend",
          this.emitGestureEvent
        );

        this.targetElement.addEventListener(
          "touchmove",
          this.emitGestureEvent
        );
      },

      remove: function () {
        this.targetElement.removeEventListener(
          "touchstart",
          this.emitGestureEvent
        );

        this.targetElement.removeEventListener(
          "touchend",
          this.emitGestureEvent
        );

        this.targetElement.removeEventListener(
          "touchmove",
          this.emitGestureEvent
        );
      },

      emitGestureEvent(event) {
        const currentState = this.getTouchState(event);

        const previousState = this.internalState.previousState;

        const gestureContinues =
          previousState &&
          currentState &&
          currentState.touchCount == previousState.touchCount;

        const gestureEnded = previousState && !gestureContinues;

        const gestureStarted = currentState && !gestureContinues;

        if (gestureEnded) {
          const eventName =
            this.getEventPrefix(previousState.touchCount) + "fingerend";

          this.el.emit(eventName, previousState);

          this.internalState.previousState = null;
        }

        if (gestureStarted) {
          currentState.startTime = performance.now();

          currentState.startPosition = currentState.position;

          currentState.startSpread = currentState.spread;

          const eventName =
            this.getEventPrefix(currentState.touchCount) + "fingerstart";

          this.el.emit(eventName, currentState);

          this.internalState.previousState = currentState;
        }

        if (gestureContinues) {
          const eventDetail = {
            positionChange: {
              x: currentState.position.x - previousState.position.x,

              y: currentState.position.y - previousState.position.y
            }
          };

          if (currentState.spread) {
            eventDetail.spreadChange =
              currentState.spread - previousState.spread;
          }

          // Update state with new data

          Object.assign(previousState, currentState);

          // Add state data to event detail

          Object.assign(eventDetail, previousState);

          const eventName =
            this.getEventPrefix(currentState.touchCount) + "fingermove";

          this.el.emit(eventName, eventDetail);
        }
      },

      getTouchState: function (event) {
        if (event.touches.length === 0) {
          return null;
        }

        // Convert event.touches to an array so we can use reduce

        const touchList = [];

        for (let i = 0; i < event.touches.length; i++) {
          touchList.push(event.touches[i]);
        }

        const touchState = {
          touchCount: touchList.length
        };

        // Calculate center of all current touches

        const centerPositionRawX =
          touchList.reduce((sum, touch) => sum + touch.clientX, 0) /
          touchList.length;

        const centerPositionRawY =
          touchList.reduce((sum, touch) => sum + touch.clientY, 0) /
          touchList.length;

        touchState.positionRaw = {
          x: centerPositionRawX,
          y: centerPositionRawY
        };

        // Scale touch position and spread by average of window dimensions

        const screenScale = 2 / (window.innerWidth + window.innerHeight);

        touchState.position = {
          x: centerPositionRawX * screenScale,
          y: centerPositionRawY * screenScale
        };

        // Calculate average spread of touches from the center point

        if (touchList.length >= 2) {
          const spread =
            touchList.reduce((sum, touch) => {
              return (
                sum +
                Math.sqrt(
                  Math.pow(centerPositionRawX - touch.clientX, 2) +
                  Math.pow(centerPositionRawY - touch.clientY, 2)
                )
              );
            }, 0) / touchList.length;

          touchState.spread = spread * screenScale;
        }

        return touchState;
      },


      getEventPrefix(touchCount) {
        const numberNames = ["one", "two", "three", "many"];

        return numberNames[Math.min(touchCount, 4) - 1];
      }
    });
  </script>
  <!-- gesture handling to control 3d objects -->
  <script>
    AFRAME.registerComponent("gesture-handler", {
      schema: {
        enabled: { default: true },
        rotationFactor: { default: 5 },
        minScale: { default: 0.3 },
        maxScale: { default: 8 },
        positionFactor: { default: 10 }
      },

      init: function () {
        this.handleScale = this.handleScale.bind(this);
        this.handleRotation = this.handleRotation.bind(this);
        this.handlePosition = this.handlePosition.bind(this);

        this.isVisible = false;
        this.initialScale = this.el.object3D.scale.clone();
        this.scaleFactor = 1;

        this.el.sceneEl.addEventListener("markerFound", e => {
          this.isVisible = true;
        });

        this.el.sceneEl.addEventListener("markerLost", e => {
          this.isVisible = false;
        });
      },
      update: function () {
        if (this.data.enabled) {
          this.el.sceneEl.addEventListener(
            "onefingermove",
            this.handleRotation
          );
          this.el.sceneEl.addEventListener(
            "onefingermove",
            this.handlePosition
          );
          this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
        } else {
          this.el.sceneEl.removeEventListener(
            "onefingermove",
            this.handleRotation
          );
          this.el.sceneEl.removeEventListener(
            "onefingermove",
            this.handlePosition
          );
          this.el.sceneEl.removeEventListener(
            "twofingermove",
            this.handleScale
          );
        }
      },

      remove: function () {
        this.el.sceneEl.removeEventListener(
          "onefingermove",
          this.handleRotation
        );
        this.el.sceneEl.removeEventListener(
          "onefingermove",
          this.handlePosition
        );
        this.el.sceneEl.removeEventListener(
          "twofingermove",
          this.handleScale
        );
      },
      handleRotation: function (event) {
        if (this.isVisible) {
          this.el.object3D.rotation.y +=
            event.detail.positionChange.x * this.data.rotationFactor;
          this.el.object3D.rotation.x +=
            event.detail.positionChange.y * this.data.rotationFactor;
        }
      },
      handlePosition: function (event) {
        if (false) {
          this.el.object3D.position.y +=
            event.detail.positionChange.y * this.data.positionFactor;
          this.el.object3D.position.x +=
            event.detail.positionChange.x * this.data.positionFactor;
        }
      },

      handleScale: function (event) {
        if (this.isVisible) {
          this.scaleFactor *=
            1 + event.detail.spreadChange / event.detail.startSpread;

          this.scaleFactor = Math.min(
            Math.max(this.scaleFactor, this.data.minScale),
            this.data.maxScale
          );

          this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
          this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
          this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
        }
      }
    });
  </script>

  <!-- Activate imageslider with dynamic properties -->
  <script>

    let slides;
    AFRAME.registerComponent("image-slider-activate", {
      schema: {
        enabled: { default: true },
        images: {
          default: [{ img: '#my-image5', width: 120, height: 80, headline: 'peace' }, { img: '#my-image3', width: 120, height: 80, headline: 'was geht' }]
        },
        markerId: { default: "yo" }
      },

      init: function () {
        this.index = 0;
        this.isVisible = false;
        slides = ["#my-image", "#my-image2", "#my-image3", "#my-image4", "#my-image5"];

        let images = this.data.images;
        let img__index = slides.indexOf(slider.getAttribute("src"));
        let markerId = this.data.markerId;
        let widthDim = parseInt(images[img__index * 4 + 1].toString().substring(6, 11)) ?? 120


        let heightDim = parseInt(images[img__index * 4 + 2].toString().substring(7, 12)) ?? 100
        let inc__button = document.getElementById("btn__nextimage");
        let buttons = document.getElementById("buttons");
        let element = document.getElementById("image-slider");
        let marker = document.getElementById(markerId);
        let img__text = document.getElementById("img__text")
        const camera = document.querySelector("[camera]");

        disableZoom = document.createElement("meta")
        disableZoom.setAttribute("name", "viewport")
        disableZoom.setAttribute("content", "width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no")


        // const click__event = new MouseEvent("click", { view: window, bubbles: true, cancelable: true });

        marker.addEventListener("markerFound", e => {
          this.isVisible = true;

          buttons.classList.remove("hidden");
          // inc__button.dispatchEvent(click__event)
          cameraPosition = camera.object3D.position;
          markerPosition = marker.object3D.position;
          document.querySelector("head").appendChild(disableZoom)


          setInterval(() => {
            distance = cameraPosition.distanceTo(markerPosition);
            if (this.isVisible) {
              img__text.innerHTML = images[img__index * 4 + 3].toString().substring(9, 25).replace("}", "").replace("]", "").replace("'", "").replace("'", "")
              img__index = slides.indexOf(slider.getAttribute("src"));
              widthDim = parseInt(images[img__index * 4 + 1].toString().substring(6, 11)) ?? 120
              heightDim = parseInt(images[img__index * 4 + 2].toString().substring(7, 12)) ?? 100
              let slide__height = (heightDim / distance);
              let slide__width = (widthDim / distance);
              // limit size
              if (slide__width * 895 < (window.screen.width - 30)) {
                element.setAttribute("width", slide__width.toString());
                element.setAttribute("height", slide__height.toString());
                buttons.style = `width: ${slide__width * 895}px; height: ${slide__height * 885}px;}`
              }


            } else {
              element.setAttribute("width", "0.000000000000001");
              element.setAttribute("height", "0.000000000000001");
            }

          }, 100)

        });

        marker.addEventListener("markerLost", e => {
          this.isVisible = false;

          buttons.classList.add("hidden");
          document.querySelector("head").removeChild(disableZoom)

          element.setAttribute("width", "0.00000000002");
          element.setAttribute("height", "0.00000000001");
        });
      },
      tick: function (time, deltaTime) {

      }
    });

  </script>

  <style>
    body,
    html {
      height: 100%;
      margin: 0;
      padding: 0;
    }



    div.wrap {
      height: 100%;
      overflow: hidden;
    }

    .arjs-loader {
      height: 100vh;
      width: 100vw;
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: "black";
    }

    .arjs-loader div {
      text-align: center;
      font-size: 2em;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }


    .center {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .buttons {
      z-index: 10;
      border-left-width: 15px;
      border-right-width: 15px;
      border-bottom-width: 40px;
      border-top-width: 15px;
      border-color: white;
      border-style: solid;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      position: relative;
      bottom: 5.5%;
      left: 2.05%
    }


    .say-hi-button {
      padding: 0.25em;
      border-radius: 4px;
      border: none;
      background: none;
      color: black;
      width: 50px;
      height: 30px;
      position: relative;
      top: 35px;
    }

    .say-bye-button {
      padding: 0.25em;
      border-radius: 4px;
      border: none;
      background: none;
      color: black;
      width: 50px;
      height: 30px;
      position: relative;
      top: 35px;
    }



    .hidden {
      display: none;
      pointer-events: none;
    }

    .hidden button {
      display: none;
      pointer-events: none;
    }

    .img__text {
      position: relative;
      top: 40px;
    }

    .hidden p {
      display: none;
      pointer-events: none;
    }
  </style>
</head>

<body style="margin : 0px; overflow: hidden;" id="body">
  <div class="wrap">


    <div class="arjs-loader">
      <div>
        <p>Es Lädt bitte warten...</p>
      </div>
    </div>
    <div class="center">
      <div class="buttons hidden" id="buttons">
        <button class="say-hi-button " id="btn__lastimage">
          <svg version="1.1" id="Ebene_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px" y="0px" viewBox="0 0 57.8 25.4" style="enable-background:new 0 0 57.8 25.4;" xml:space="preserve">
            <path d="M0.4,11.8L0.4,11.8c0-0.1,0-0.1,0.1-0.2c0-0.1,0.1-0.1,0.1-0.1L13.8,0.3c0.6-0.5,1.6-0.4,2.1,0.2s0.4,1.6-0.2,2.1L5.6,11.2
	h50.7c0.8,0,1.5,0.7,1.5,1.5s-0.7,1.5-1.5,1.5H5.6l10.1,8.6c0.7,0.5,0.7,1.5,0.2,2.1c-0.3,0.3-0.7,0.5-1.1,0.5s-0.7-0.1-1-0.3
	L0.4,13.8l0,0c0-0.1-0.1-0.1-0.1-0.2l0,0C0.1,13.4,0,13,0,12.7C0,12.4,0.1,12.1,0.4,11.8z" />
          </svg>

        </button>
        <p class="img__text" id="img__text">yo</p>
        <button class="say-bye-button " id="btn__nextimage">
          <svg version="1.1" id="Ebene_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px" y="0px" viewBox="0 0 57.8 25.4" style="enable-background:new 0 0 57.8 25.4;" xml:space="preserve">
            <path d="M57.8,12.7c0,0.3-0.1,0.7-0.3,0.9c0,0,0,0,0,0c0,0.1-0.1,0.1-0.1,0.2c0,0,0,0,0,0L44,25.1c-0.3,0.2-0.6,0.3-1,0.3
         c-0.4,0-0.8-0.2-1.1-0.5c-0.5-0.6-0.5-1.6,0.2-2.1l10.1-8.6H1.5c-0.8,0-1.5-0.7-1.5-1.5c0-0.8,0.7-1.5,1.5-1.5h50.7L42.1,2.6
         c-0.6-0.5-0.7-1.5-0.2-2.1c0.5-0.6,1.5-0.7,2.1-0.2l13.2,11.2c0,0,0.1,0,0.1,0.1c0.1,0.1,0.1,0.1,0.1,0.2c0,0,0,0,0,0
         C57.7,12.1,57.8,12.4,57.8,12.7z" />
          </svg>
        </button>
      </div>
    </div>


    <!-- a-frame scene -->
    <a-scene vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true;" embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; sourceWidth:640; sourceHeight:480; displayWidth: 640; displayHeight: 480;"
      gesture-detector id="scene">
      <a-assets>
        <img id="my-image"
          src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fmery.jpg?v=1619597239473" />
        <img id="my-image2"
          src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fme.jpg?v=1619597297120" />
        <img id="my-image3"
          src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2FSlide_1.jpg?v=1619598198727" />
        <img id="my-image4"
          src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2FSlide_2.jpg?v=1619598223588" />
        <img id="my-image5"
          src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fimage--010.jpg?v=1621338004993" />
        <a-asset-item id="bowser" response-type="arraybuffer"
          src="https://cdn.glitch.com/06bd98b4-97ee-4c07-a546-fe39ca205034%2Fbowser.glb">
        </a-asset-item>
        <a-asset-item id="area1" response-type="arraybuffer"
          src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fblockmodell_blender.glb?v=1620728303190">
        </a-asset-item>

        <a-asset-item id="bird" response-type="arraybuffer"
          src="https://cdn.glitch.com/1061d524-9d0f-4b25-97fd-48ebd0fce63c%2Fsceneglb.glb?1546534633849"></a-asset-item>
      </a-assets>

      <a-nft type="nft" url="https://transfer.short-cuts.cloud/paular/tracker/vier/vier">
        <a-entity position="5 150 -150" gltf-model="#bowser" scale="5 5 5"></a-entity>
      </a-nft>

      <!-- <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/PetabitMan/TC-flyer/master/tracker/lion/lion">
        <a-entity position="5 150 -150" gltf-model="#area1" scale="1 1 1"></a-entity>
      </a-nft> -->

      <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/005/005"
        smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5" raycaster="objects: .clickable"
        emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
        <a-entity position="0 0 -50" gltf-model="#area1" scale="1 1 1" class="clickable" gesture-handler></a-entity>
      </a-nft>

      <a-nft type="nft" id="peace"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/kala/kala"
        smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5" raycaster="objects: .clickable"
        emitevents="true" cursor="fuse: false; rayOrigin: mouse;">

        <a-entity
          gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
          position="50 150 -200" scale="2 2 2" class="clickable" gesture-handler></a-entity>>

      </a-nft>
      <!-- <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/yo/yo"
        smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5" raycaster="objects: .clickable"
        emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
        <a-entity position="0 0 -50" gltf-model="#area1" scale="1 1 1" class="clickable" gesture-handler></a-entity>
      </a-nft> -->
      <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/010/image--010"
        id="yo" emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
        <a-entity scale="1 1 1" position="50 150 -200" rotation="-90 0 0">
          <a-entity class="clickable"
            image-slider-activate="markerId: yo; images: [{img: '#my-image, width: 120, height: 120, headline: 'test'}, {img: '#my-image2, width: 120, height: 80, headline: 'yo'}, {img: '#my-image3, width: 100, height: 60, headline: 'was geht'},  {img: '#my-image4, width: 120, height: 80, headline: 'was geeeeht'},  {img: '#my-image5, width: 120, height: 80, headline: 'lol'}]">
          </a-entity>
        </a-entity>
      </a-nft>

      <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/013/image--013"
        id="banana" emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
        <a-entity scale="1 1 1" position="50 150 -200" rotation="-90 0 0">

          <a-entity class="clickable"
            image-slider-activate="markerId: banana; images: [{img: '#my-image, width: 80, height: 120, headline: 'test'}, {img: '#my-image2, width: 120, height: 80, headline: 'yo'}, {img: '#my-image3, width: 100, height: 60, headline: 'was geht'},  {img: '#my-image4, width: 120, height: 80, headline: 'was geeeeht'},  {img: '#my-image5, width: 120, height: 80, headline: 'lol'}]">
          </a-entity>

        </a-entity>
      </a-nft>

      <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/018/image--018"
        smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5" raycaster="objects: .clickable"
        emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
        <a-entity position="50 150 -250" gltf-model="#bird" scale="0.8 0.8 0.8"
          animation-mixer="clip:Take 001; loop:2; timeScale: 0.5; crossFadeDuration: 1" class="clickable"
          gesture-handler>
        </a-entity>
      </a-nft>

      <!-- <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/TCB_Broschuere_Grafik/TCB_Broschuere_Grafik"
        smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5">
        <a-entity position="5 150 -150" gltf-model="#area1" rotation="-90 0 0" scale="1 1 1"></a-entity>
      </a-nft> -->

      <a-nft type="nft"
        url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/023/image--023"
        smooth="true" smoothcount="5" smoothtolerance=".01" smooththreshold="10" raycaster="objects: .clickable"
        emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
        <a-entity
          gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
          position="0 0 0" scale="5 5 5" class="clickable" gesture-handler></a-entity>
      </a-nft>

      <a-entity camera>
        <a-entity cursor="fuse: true; fuseTimeout: 1000" position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.008" material="color: grey; shader: flat">
          <a-image width="0.00000012" height="0.00000006" src="#my-image" id="image-slider"></a-image>
        </a-entity>
      </a-entity>
    </a-scene>
  </div>
  <script>

    let next__button = document.getElementById("btn__nextimage");
    let back__button = document.getElementById("btn__lastimage");
    let slider = document.getElementById("image-slider");


    next__button.addEventListener("click", () => {
      let slideindex = slides.indexOf(slider.getAttribute("src"));
      if (slides.length - 1 === slideindex) {
        slider.setAttribute("src", slides[0]);
      } else {
        slider.setAttribute("src", slides[(slideindex += 1)]);
      }

    });
    back__button.addEventListener("click", () => {
      let slideindex = slides.indexOf(slider.getAttribute("src"));
      if (slideindex === 0) {
        slider.setAttribute("src", slides[slides.length - 1]);
      } else {
        slider.setAttribute("src", slides[(slideindex -= 1)]);
      }

    });
  </script>

</body>

</html>