<!DOCTYPE html>
<html>

<head>
  <script
    src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>

  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v5.0.1/dist/aframe-extras.min.js"></script>
  <script>
    AFRAME.registerComponent("gesture-detector", {
      schema: {
        element: { default: "" }
      },

      init: function () {
        this.targetElement =
          this.data.element && document.querySelector(this.data.element);

        if (!this.targetElement) {
          this.targetElement = this.el;
        }

        this.internalState = {
          previousState: null
        };

        this.emitGestureEvent = this.emitGestureEvent.bind(this);

        this.targetElement.addEventListener(
          "touchstart",
          this.emitGestureEvent
        );

        this.targetElement.addEventListener(
          "touchend",
          this.emitGestureEvent
        );

        this.targetElement.addEventListener(
          "touchmove",
          this.emitGestureEvent
        );
      },

      remove: function () {
        this.targetElement.removeEventListener(
          "touchstart",
          this.emitGestureEvent
        );

        this.targetElement.removeEventListener(
          "touchend",
          this.emitGestureEvent
        );

        this.targetElement.removeEventListener(
          "touchmove",
          this.emitGestureEvent
        );
      },

      emitGestureEvent(event) {
        const currentState = this.getTouchState(event);

        const previousState = this.internalState.previousState;

        const gestureContinues =
          previousState &&
          currentState &&
          currentState.touchCount == previousState.touchCount;

        const gestureEnded = previousState && !gestureContinues;

        const gestureStarted = currentState && !gestureContinues;

        if (gestureEnded) {
          const eventName =
            this.getEventPrefix(previousState.touchCount) + "fingerend";

          this.el.emit(eventName, previousState);

          this.internalState.previousState = null;
        }

        if (gestureStarted) {
          currentState.startTime = performance.now();

          currentState.startPosition = currentState.position;

          currentState.startSpread = currentState.spread;

          const eventName =
            this.getEventPrefix(currentState.touchCount) + "fingerstart";

          this.el.emit(eventName, currentState);

          this.internalState.previousState = currentState;
        }

        if (gestureContinues) {
          const eventDetail = {
            positionChange: {
              x: currentState.position.x - previousState.position.x,

              y: currentState.position.y - previousState.position.y
            }
          };

          if (currentState.spread) {
            eventDetail.spreadChange =
              currentState.spread - previousState.spread;
          }

          // Update state with new data

          Object.assign(previousState, currentState);

          // Add state data to event detail

          Object.assign(eventDetail, previousState);

          const eventName =
            this.getEventPrefix(currentState.touchCount) + "fingermove";

          this.el.emit(eventName, eventDetail);
        }
      },

      getTouchState: function (event) {
        if (event.touches.length === 0) {
          return null;
        }

        // Convert event.touches to an array so we can use reduce

        const touchList = [];

        for (let i = 0; i < event.touches.length; i++) {
          touchList.push(event.touches[i]);
        }

        const touchState = {
          touchCount: touchList.length
        };

        // Calculate center of all current touches

        const centerPositionRawX =
          touchList.reduce((sum, touch) => sum + touch.clientX, 0) /
          touchList.length;

        const centerPositionRawY =
          touchList.reduce((sum, touch) => sum + touch.clientY, 0) /
          touchList.length;

        touchState.positionRaw = {
          x: centerPositionRawX,
          y: centerPositionRawY
        };

        // Scale touch position and spread by average of window dimensions

        const screenScale = 2 / (window.innerWidth + window.innerHeight);

        touchState.position = {
          x: centerPositionRawX * screenScale,
          y: centerPositionRawY * screenScale
        };

        // Calculate average spread of touches from the center point

        if (touchList.length >= 2) {
          const spread =
            touchList.reduce((sum, touch) => {
              return (
                sum +
                Math.sqrt(
                  Math.pow(centerPositionRawX - touch.clientX, 2) +
                  Math.pow(centerPositionRawY - touch.clientY, 2)
                )
              );
            }, 0) / touchList.length;

          touchState.spread = spread * screenScale;
        }

        return touchState;
      },

      getEventPrefix(touchCount) {
        const numberNames = ["one", "two", "three", "many"];

        return numberNames[Math.min(touchCount, 4) - 1];
      }
    });
  </script>

  <script>
    AFRAME.registerComponent("gesture-handler", {
      schema: {
        enabled: { default: true },
        rotationFactor: { default: 5 },
        minScale: { default: 0.3 },
        maxScale: { default: 8 },
        positionFactor: { default: 10 }
      },

      init: function () {
        this.handleScale = this.handleScale.bind(this);
        this.handleRotation = this.handleRotation.bind(this);
        this.handlePosition = this.handlePosition.bind(this);

        this.isVisible = false;
        this.initialScale = this.el.object3D.scale.clone();
        this.scaleFactor = 1;

        this.el.sceneEl.addEventListener("markerFound", e => {
          this.isVisible = true;
        });

        this.el.sceneEl.addEventListener("markerLost", e => {
          this.isVisible = false;
        });
      },

      update: function () {
        if (this.data.enabled) {
          this.el.sceneEl.addEventListener(
            "onefingermove",
            this.handleRotation
          );
          this.el.sceneEl.addEventListener(
            "onefingermove",
            this.handlePosition
          );
          this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
        } else {
          this.el.sceneEl.removeEventListener(
            "onefingermove",
            this.handleRotation
          );
          this.el.sceneEl.removeEventListener(
            "onefingermove",
            this.handlePosition
          );
          this.el.sceneEl.removeEventListener(
            "twofingermove",
            this.handleScale
          );
        }
      },

      remove: function () {
        this.el.sceneEl.removeEventListener(
          "onefingermove",
          this.handleRotation
        );
        this.el.sceneEl.removeEventListener(
          "onefingermove",
          this.handlePosition
        );
        this.el.sceneEl.removeEventListener(
          "twofingermove",
          this.handleScale
        );
      },
      handleRotation: function (event) {
        if (this.isVisible) {
          this.el.object3D.rotation.y +=
            event.detail.positionChange.x * this.data.rotationFactor;
          this.el.object3D.rotation.x +=
            event.detail.positionChange.y * this.data.rotationFactor;
        }
      },
      handlePosition: function (event) {
        if (false) {
          this.el.object3D.position.y +=
            event.detail.positionChange.y * this.data.positionFactor;
          this.el.object3D.position.x +=
            event.detail.positionChange.x * this.data.positionFactor;
        }
      },

      handleScale: function (event) {
        if (this.isVisible) {
          this.scaleFactor *=
            1 + event.detail.spreadChange / event.detail.startSpread;

          this.scaleFactor = Math.min(
            Math.max(this.scaleFactor, this.data.minScale),
            this.data.maxScale
          );

          this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
          this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
          this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
        }
      }
    });

    AFRAME.registerComponent("gesture-images", {
      schema: {
        enabled: { default: true },
        images: {
          default: ["#my-image", "my-image2", "#my-image3", "my-image4"]
        },
        widthDim: { default: 115 },
        heightDim: { default: 180 },
        markerId: { default: "yo" }
      },

      init: function () {
        this.index = 0;
        this.isVisible = false;

        let images = this.data.images;
        let markerId = this.data.markerId;
        let widthDim = this.data.widthDim;
        let heightDim = this.data.heightDim;

        let inc__button = document.getElementById("btn__nextimage");
        let element = document.getElementById("image-slider");
        let marker = document.getElementById(markerId);
        const camera = document.querySelector("[camera]");

        marker.addEventListener("markerFound", e => {
          this.isVisible = true;

          inc__button.classList.remove("hidden");

          cameraPosition = camera.object3D.position;
          markerPosition = marker.object3D.position;
          distance = cameraPosition.distanceTo(markerPosition);
          element.setAttribute("width", (widthDim / distance).toString());
          element.setAttribute("height", (heightDim / distance).toString());
        });

        marker.addEventListener("markerLost", e => {
          this.isVisible = false;

          inc__button.classList.add("hidden");

          element.setAttribute("width", "0.00000000002");
          element.setAttribute("height", "0.00000000001");
        });
      }
    });

    AFRAME.registerComponent("change-color-on-hover", {
      schema: {
        color: { default: "blue" }
      },

      init: function () {
        let data = this.data;
        let images = ["#my-image", "my-image4", "#my-image2", "my-image3"];
        let change = 1;
        let currentImage = 0;
        if (this.data.color === "red") {
          change = -1;
        }
        let el = this.el;
        let defaultColor = el.getAttribute("material").color;

        el.addEventListener("mouseenter", function () {
          el.setAttribute("color", data.color);
          setTimeout(() => {
            document
              .getElementById("testing-image")
              .setAttribute("src", "#my-image");
            currentImage += change;
          }, 500);
        });

        el.addEventListener("mouseleave", function () {
          el.setAttribute("color", defaultColor);
        });
      }
    });
  </script>

  <style>
    .arjs-loader {
      height: 100vh;
      width: 100vw;
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: "black";
    }

    .arjs-loader div {
      text-align: center;
      font-size: 2em;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .buttons {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5em;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .say-hi-button {
      padding: 0.25em;
      border-radius: 4px;
      border: none;
      background: white;
      color: black;
      width: 4em;
      height: 2em;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body style="margin : 0px; overflow: hidden;" id="body">
  <div class="arjs-loader">
    <div>
      <p>Es Lädt bitte warten...</p>
    </div>
  </div>
  <div class="buttons">
    <button id="btn__nextimage" class="say-hi-button hidden">
      Next Image
    </button>
  </div>

  <!-- a-frame scene -->
  <a-scene vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true;" embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; sourceWidth:640; sourceHeight:480; displayWidth: 640; displayHeight: 480;"
    gesture-detector id="scene">
    <a-assets>
      <img id="my-image" src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fmery.jpg?v=1619597239473" />
      <img id="my-image2" src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fme.jpg?v=1619597297120" />
      <img id="my-image3"
        src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2FSlide_1.jpg?v=1619598198727" />
      <img id="my-image4"
        src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2FSlide_2.jpg?v=1619598223588" />
      <img id="my-image5"
        src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fimage--010.jpg?v=1621338004993" />
      <a-asset-item id="bowser" response-type="arraybuffer"
        src="https://cdn.glitch.com/06bd98b4-97ee-4c07-a546-fe39ca205034%2Fbowser.glb">
      </a-asset-item>
      <a-asset-item id="area1" response-type="arraybuffer"
        src="https://cdn.glitch.com/280b4493-9a96-4882-ace7-2c7060cc4d01%2Fblockmodell_blender.glb?v=1620728303190">
      </a-asset-item>

      <a-asset-item id="bird" response-type="arraybuffer"
        src="https://cdn.glitch.com/1061d524-9d0f-4b25-97fd-48ebd0fce63c%2Fsceneglb.glb?1546534633849"></a-asset-item>
    </a-assets>

    <a-nft type="nft" url="https://transfer.short-cuts.cloud/paular/tracker/vier/vier">
      <a-entity position="5 150 -150" gltf-model="#bowser" scale="5 5 5"></a-entity>
    </a-nft>

    <a-nft type="nft"
      url="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/PetabitMan/TC-flyer/master/tracker/lion/lion">
      <a-entity position="5 150 -150" gltf-model="#area1" scale="1 1 1"></a-entity>
    </a-nft>

    <a-nft type="nft"
      url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/005/005"
      smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5" raycaster="objects: .clickable"
      emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
      <a-entity position="0 0 -50" gltf-model="#area1" scale="1 1 1" class="clickable" gesture-handler></a-entity>
    </a-nft>

    <a-nft type="nft"
      url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/010/image--010"
      smooth="true" smoothcount="1" smoothtolerance=".01" smooththreshold="1" id="yo" raycaster="objects: .clickable"
      emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
      <a-entity scale="1 1 1" position="50 150 -200" rotation="-90 0 0">
        <a-entity class="clickable" gesture-images=""></a-entity>
      </a-entity>
    </a-nft>

    <a-nft type="nft"
      url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/013/image--013"
      smooth="true" smoothcount="50" smoothtolerance=".01" smooththreshold="5">
      <a-entity scale="1.2 1.2 1.2" position="5 150 -150" rotation="-90 0 0">
        <a-entity position="-50 0 0">
          <a-cylinder color="white" height="40" radius="5" change-color-on-hover="color: red"></a-cylinder>
        </a-entity>
        <a-image id="testing-image" width="80" height="40" src="#my-image3"></a-image>
        <a-entity position="50 0 0">
          <a-cylinder color="white" height="40" radius="5" change-color-on-hover="color: green"></a-cylinder>
        </a-entity>
      </a-entity>
    </a-nft>

    <a-nft type="nft"
      url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/018/image--018"
      smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5" raycaster="objects: .clickable"
      emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
      <a-entity position="50 150 -250" gltf-model="#bird" scale="0.8 0.8 0.8"
        animation-mixer="clip:Take 001; loop:2; timeScale: 0.5; crossFadeDuration: 1" class="clickable" gesture-handler>
      </a-entity>
    </a-nft>

    <a-nft type="nft"
      url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/TCB_Broschuere_Grafik/TCB_Broschuere_Grafik"
      smooth="true" smoothcount="10" smoothtolerance=".01" smooththreshold="5">
      <a-entity position="5 150 -150" gltf-model="#area1" rotation="-90 0 0" scale="1 1 1"></a-entity>
    </a-nft>

    <a-nft type="nft"
      url="https://arjs-cors-proxy.herokuapp.com/https://rawcdn.githack.com/PetabitMan/TC-flyer/master/tracker/023/image--023"
      smooth="true" smoothcount="5" smoothtolerance=".01" smooththreshold="10" raycaster="objects: .clickable"
      emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
      <a-entity
        gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
        position="0 0 0" scale="5 5 5" class="clickable" gesture-handler></a-entity>
    </a-nft>

    <a-entity camera>
      <a-entity cursor="fuse: true; fuseTimeout: 1000" position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.008" material="color: grey; shader: flat">
        <a-image width="0.00000012" height="0.00000006" src="#my-image5" id="image-slider"></a-image>
      </a-entity>
    </a-entity>
  </a-scene>
  <script>
    let button = document.getElementById("btn__nextimage");

    let slider = document.getElementById("image-slider");
    let slides = [
      "#my-image5",
      "#my-image2",
      "#my-image4",
      "#my-image3",
      "#my-image"
    ];

    button.addEventListener("click", () => {
      let slideindex = slides.indexOf(slider.getAttribute("src"));
      if (slides.length - 1 === slideindex) {
        slider.setAttribute("src", slides[0]);
      } else {
        slider.setAttribute("src", slides[(slideindex += 1)]);
      }

    });
  </script>
</body>

</html>